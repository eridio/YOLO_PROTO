<html lang="fr">
<head>
  <title>YOLO</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <link rel="stylesheet" href="css/main.css">
  <script type="application/javascript" src="/socket.io/socket.io.js"></script>

  <!-- Font Awesome File -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script type="module">
        
    import init, {key_init_alice, key_init_bob,calculate_master_key_alice, calculate_master_key_bob, alice_init_ratchet,bob_init_ratchet, decrypt, send} from './pkg/helloworld.js'
    localStorage.clear();
    async function run() {
        await init()
        document.body.textContent = helloworld()
      }
    
     async function postBundle(json_to_send){
        let xhr = new XMLHttpRequest();
        xhr.open("POST", `http://localhost:4200/stock_bundle`, true);
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.send(JSON.stringify(json_to_send));
        //console.log(json_to_send)
      }
     async function getBundleof(username){
        let json_to_send = JSON.stringify({"name_" : username})
        console.log(json_to_send)
        let xhr = new XMLHttpRequest();
        xhr.open("POST", `http://localhost:4200/get_bundle_of`, true);
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.send((json_to_send));
        xhr.onload = async () => {
        if (xhr.readyState === 4) {
            if (xhr.status === 200) {
                console.log(xhr.statusText);
                await parseData(xhr.responseText);
            } else {
                console.error(xhr.statusText);
            }
        }
    };
    xhr.onerror = () => {
        console.error(xhr.statusText);
    };
       
        
      }
     
    function parseData(response) {
      
        console.log("response du serveur de kdc" + JSON.parse(response))
        localStorage.setItem("bundle_from_server",JSON.stringify(response))
    }
    
    async function init_alice(){
        await init()
       // import('./../pkg/helloworld.js')
        let init_alice = key_init_alice()
        let json = JSON.parse(init_alice)
    
        localStorage.setItem("alice_bundle" , JSON.stringify(json))
        let bundle_complete = localStorage.getItem("alice_bundle")
        
        //console.log(JSON.parse(bundle_complete).bundle_keep)
    
       //console.log(json.bundle_server)
        postBundle(json.bundle_server)
       console.log("INIT DONE")
    
      }
      async function init_bob(){
        await init()
        let init_bob = key_init_bob()
        let json = JSON.parse(init_bob)
        localStorage.setItem("bob_bundle" , JSON.stringify(json))
       // console.log(json.bundle_keep)
       postBundle(json.bundle_server)
       console.log("INIT DONE")
      }
    
      async function master_key_alice(){
        await init()
        let alice_local = JSON.parse(localStorage.getItem("alice_bundle"))
        let bob_from_server = await getBundleof("bob")
        console.log("master_key_alice  apres le get bob server")
        let bob_server = JSON.parse(localStorage.getItem("bundle_from_server"))
        
        let master_key_alice_part = calculate_master_key_alice(JSON.stringify(bob_server),JSON.stringify(alice_local.bundle_keep))
        console.log(master_key_alice_part)
        localStorage.setItem("master_key_alice_part",master_key_alice_part)
        // let json = JSON.parse(master_key_alice_part)
        // console.log(json)
      }
      async function master_key_bob(){
        await init()
        let alice_bundle_from_server = await getBundleof("Alice")
        console.log(alice_bundle_from_server)
        let alice_from_server = JSON.parse(localStorage.getItem("bundle_from_server"))
        let bob_local = JSON.parse(localStorage.getItem("bob_bundle"))
        console.log("BUNDLE ALICE RECUP DU SERVEUR PAR BOB DANS MASTER KEY BOB " +  localStorage.getItem("bundle_from_server"))


        let master_key_bob_part = calculate_master_key_bob(JSON.stringify(bob_local.bundle_keep),JSON.stringify(alice_from_server))
        console.log(master_key_bob_part)
        localStorage.setItem("master_key_bob_part",master_key_bob_part)
        // let json = JSON.parse(master_key_alice_part)
        // console.log(json)
      }
    
      async function bob_init_ratchet_js(){
        await init()
        let sk = localStorage.getItem("master_key_bob_part")
        let ratchetAndPubKeyBob = bob_init_ratchet(sk)
        let json = JSON.parse(ratchetAndPubKeyBob)
        console.log(json)
        localStorage.setItem("bob_ratchet_string",json.ratchet)
        localStorage.setItem("bob_pub_key_from_ratchet" , json.pub_key)
      }
    
      async function alice_init_ratchet_js(){
        await init()
        let sk = localStorage.getItem("master_key_alice_part")
        let public_key_bob = localStorage.getItem("bob_pub_key_from_ratchet")
        let ratchetAlice = alice_init_ratchet(sk,public_key_bob)
        let json = JSON.parse(ratchetAlice)
    
        console.log(json)
        localStorage.setItem("alice_ratchet",json)
        
      }
    
      async function alice_send_js(message){
    
        await init()
        let alice_ratchet = localStorage.getItem("alice_ratchet")
        let ratchet_and_message_bundle = send(alice_ratchet, message)
        let json = JSON.parse(ratchet_and_message_bundle)
        localStorage.setItem("alice_ratchet",json.ratchet)
        console.log(json.message_bundle)
    
        let bob_ratchet = localStorage.getItem("bob_ratchet_string")
        let steuplémarche = decrypt(bob_ratchet, json.message_bundle)
        let json2 = JSON.parse(steuplémarche)
        localStorage.setItem("bob_ratchet_string",json2.ratchet)
        console.log(json2.decrypted)
    
        document.getElementById("message_display").innerHTML += `<p style="float: right;">${json2.decrypted}</p> </br>`
    
      }
    
      async function bob_send_js(message){
    
        await init()
        let bob_ratchet = localStorage.getItem("bob_ratchet_string")
        let ratchet_and_message_bundle = send(bob_ratchet, message)
        let json = JSON.parse(ratchet_and_message_bundle)
        localStorage.setItem("bob_ratchet_string",json.ratchet)
        console.log(json.message_bundle)
    
        let alice_ratchet = localStorage.getItem("alice_ratchet")
        let steuplémarche = decrypt(alice_ratchet, json.message_bundle)
        let json2 = JSON.parse(steuplémarche)
        localStorage.setItem("alice_ratchet",json2.ratchet)
        console.log(json2.decrypted)
        document.getElementById("message_display").innerHTML += `<p>${json2.decrypted}</p> </br>`
       
        }
    
        //init_alice()
        //master_key_alice()
    //########################################################-end of signal-#########################################

    var socket = io();
var userName = "patoche" + Math.random();
        

//flo
function delay(n){
    return new Promise(function(resolve){
        setTimeout(resolve,n);
    });
    }

window.onload = oninit();
async function oninit(){
    await delay(1000)
    get_your_name();
    
}

function get_your_name() {
    let xhr = new XMLHttpRequest();
    let cookie_to_send = document.cookie.substring(4,200);
    xhr.open("GET", `https://127.0.0.1:4201/get_your_name`, true);
    xhr.setRequestHeader( "Authorization","Bearer " + cookie_to_send );
    xhr.onload = () => {
        if (xhr.readyState === 4) {
            if (xhr.status === 200) {
                console.log(xhr.statusText);
                parseData_get_your_name(xhr.responseText);
            } else {
                console.error(xhr.statusText);
            }
        }
    };
    xhr.onerror = () => {
        console.error(xhr.statusText);
    };
    xhr.send(null);
}
let username;
let msg;
function parseData_get_your_name(response) {
    let json_received = JSON.parse(response);
    console.log(json_received)
    username = json_received.full_name; 
    userName = username
    
    socket.emit("request", msg = { type: "login", name: userName });
}


// ALICE = CALLER 
//BOB = CALLEE


function changeWhiteSpacesIntoUnderscore(word) {
    word = word.replace(/\s+/g, '_');
    return word;
}
function changeUnderscoreIntoWhiteSpaces(word) {
    word = word.replace('_', ' ');
    return word;
}
      var userList = new Array();
      var callee;
      var options = {
          iceServers: [
              {
                  urls: "stun:stun.l.google.com:19302"
              }
          ]
      }
      var caller;
      var pcCaller;
      var pcCallee;
      var dataChannel;


      //envoie msg 

      let SendButton = document.getElementById("button");
      SendButton.addEventListener("click", e => {
          let divMessage = document.getElementById("messageInput");
          sendMessage(dataChannel, divMessage.value);
          divMessage.value = "";
      });





      function messageReceive(dataChannel) {
          dataChannel.addEventListener("message", event => {
              console.log("Message received : " + event.data);
              let divMsg = document.getElementById("conversation");
              divMsg.innerHTML += `
              <div class="row message-body">
                  <div class="col-sm-12 message-main-receiver">
                      <div class="receiver">
                          <div class="message-text">
                                  ${event.data}
                                  </div>
                          </div>
                  </div>
              </div>
              `;//event message if event.data == "<!pubKey>="
          });
      }
      function sendMessage(dataChannel, message) {
          if (dataChannel.readyState == "open") {
              dataChannel.send(message);
              let divMsg = document.getElementById("conversation");
              divMsg.innerHTML += `
              <div class="row message-body">
                  <div class="col-sm-12 message-main-sender">
                      <div class="sender">
                          <div class="message-text">
                          ${message}
                          </div>
                      </div>
                  </div>
              </div>
              `;
          }
      };
      function displayOffer(senderName) {
          let divModal = document.getElementById("modal");
          divModal.innerHTML += `<div id="offer" class="modal">
              <div class="modal-dialog">
                <div class="modal-content">
                  <header class="modalContainer"> Offer By ${senderName}</header>
                  <button class=acceptButton id=${changeWhiteSpacesIntoUnderscore(senderName)}>Accept offer send by:${senderName}</button>          
                </div >
              `;
      }

      /*
          const stream = navigator.mediaDevices.getUserMedia({ audio: true });
      
          var pcCaller = new RTCPeerConnection(options);;
          const audioTrack = stream.getTracks().array.forEach(track => {
          pcCaller.addTrack(track, stream);
          });;
      
      */


      var cells = document.getElementById("cells");
      socket.on("getUsers", users => {
          for (let i = 0; i < users.length; i++) {
              addUsers(users[i]);
          }
      });

      function addUsers(user) {
          userList.push(user);

          let id = userList.length;
          //Add to the list of user on the UI 
          let contactList = document.getElementById("friends");
          contactList.innerHTML += `
              <div class="row sideBar-body">
                  <div class="col-sm-3 col-xs-3 sideBar-avatar">
                      <div class="avatar-icon">
                          <img src="img/man-2-512.png">
                      </div>
                  </div>
                  <div class="col-sm-9 col-xs-9 sideBar-main">
                      <div class="row">
                          <div class="col-sm-8 col-xs-8 sideBar-name">
                              <span class="name-meta">${user}
                              </span>
                              <p><button class="offerButton" id="${user}">Make an offer</button></p>
                          </div>
                      </div>
                  </div>
              </div>
              `;
      //   console.log(contactList);

      };
     
      socket.on("newUser", user => {
          addUsers(user);
          //console.log(user);
      });

      socket.on("connectedUsers", usersAlreadyConnected => {
          for (let i = 0; i < usersAlreadyConnected.length; i++) {
              addUsers(usersAlreadyConnected[i]);
          }
      });

      //'''''''''''''''''''''''''''Caller side''''''''''''''''''''''''''''''''//

      // callee accepted the offer 
      socket.on("answer", async receiverName => {
          //création sdp et envoi de sdp puis de ICE
          //côté caller
          callee = receiverName;
          //console.log("Connexion accepté de :" + receiverName);

          //Creating the caller peer connection and his sdp
          if (pcCaller == undefined) {
              pcCaller = new RTCPeerConnection();
              dataChannel = pcCaller.createDataChannel("dataChannel");
              //console.log(dataChannel);
          }


          pcCaller.addEventListener('connectionstatechange', event => {
              //console.log("connection ?")
              if (pcCaller.connectionState === 'connected') {
                  // Peers connected!
                  messageReceive(dataChannel);
                  //console.log("GGWP peers connected!");
              }
          });

          var CallerSdp = await pcCaller.createOffer({ iceRestart: true });
          //Sending the caller sdp to the callee  
          socket.emit("request", { type: "sdpCaller", name: receiverName, sdp: CallerSdp, dc: dataChannel })
          //Setting the caller (his) local description
          await pcCaller.setLocalDescription(CallerSdp);
      });
      //Waiting for callee sdp 

      // when callee send spd info
      socket.on("calleeSdp", async calleeSdp => {
          //Caller set callee description
          const remoteDesc = new RTCSessionDescription(calleeSdp);
         // console.log(pcCaller.iceGatheringState);
          await pcCaller.setRemoteDescription(remoteDesc);
          //console.log("callee descripiton set");
          //console.log(remoteDesc);

          //navigator.mediaDevices.getUserMedia({ audio: true, video: true });
          //pcCaller.addStream(localStream);

          //Then 
          //Caller listen to his peerconnection for some icecandidate and when one is found the caller send it to the callee 

          //console.log(pcCaller.iceGatheringState);



          pcCaller.addEventListener('icecandidate', event => {

              if (event.candidate != null) {
                  //console.log("ice candidate found");
                  //console.log(event.candidate);
                  socket.emit("request", { type: 'iceCandidateToCallee', name: callee, candidate: event.candidate });
              }
          });

          //-------------------------------------------------------INIT----------------------------
          dataChannel.addEventListener("open",async ev => {
            await init_alice()
            // delay(1000)
            await master_key_alice()
              const readyState = dataChannel.readyState;
              //console.log("Send channel state is: " + readyState);
              sendMessage(dataChannel, "coucou bro 2");
          });
          dataChannel.addEventListener("error", ev => {
              //console.log(ev);
          });




          // Listen for connectionstatechange on the local RTCPeerConnection



      });



      socket.on('calleeIceCandidate', async calleeIceCandidate => {
          //console.log(calleeIceCandidate);
          if (calleeIceCandidate) {
              //Try to add the caller ice candidate 
              try {
                  await pcCaller.addIceCandidate(calleeIceCandidate);
                 // console.log("callee ice cadidate added");
              } catch (e) {
                  console.error('Error adding received ice candidate', e);
              }
          }
      });


      //-----------------------------Callee side----------------------------------//

      // callee received an offer from the caller 
      socket.on("offer", senderName => {
          //console.log("Demande de connexion de:" + senderName);
          displayOffer(senderName);
          //cells.innerHTML += `<button class=acceptButton id = ${senderName}> Accept offer send by:${senderName}</button >`;
      });


      //receiving a peerConnection offer from the caller (send by the signaling server)
      socket.on("pcOffer", async (callerSdp, dc) => {
          //creating the callee peer connection
          pcCallee = new RTCPeerConnection();
          // dataChannel = dc;
          // console.log(dc);
          pcCallee.addEventListener("datachannel", async ev => {
              dataChannel = ev.channel;

              //callee INIT KEY
              await init_bob()
              await master_key_bob()


              //console.log("datachannel ? : ");
              //console.log(dataChannel);
              //RATCHET INIT COTE BOB -> pub key send
              //sendMessage(dataChannel, "");
              messageReceive(dataChannel); //si ca commence par ""

          }, false);
          //messageReceive(dataChannel);
          //Setting the caller sdp description
          await pcCallee.setRemoteDescription(callerSdp);
        //  console.log("caller description set:");
          //console.log(callerSdp);

          pcCallee.addEventListener('icecandidate', event => {

              if (event.candidate != null) {
                 // console.log("ice candidate found");
                 // console.log(event.candidate);
                  socket.emit("request", { type: 'iceCandidateToCaller', name: caller, candidate: event.candidate });
              }
          });
         
          //Creating the callee sdp answer 
          var calleeSdp = await pcCallee.createAnswer();
          pcCallee.setLocalDescription(calleeSdp);

          //Sending the callee sdp to the caller 
          socket.emit("request", { type: "sdpCallee", name: caller, sdp: calleeSdp })

      });

      //Signaling server emiting caller ice candidate 
      socket.on('callerIceCandidate', async callerIceCandidate => {
         // console.log(callerIceCandidate);
          if (callerIceCandidate) {
              //Try to add the caller ice candidate 
              try {
                  await pcCallee.addIceCandidate(callerIceCandidate);
                 // console.log("caller ice cadidate added");
              } catch (e) {
                  console.error('Error adding received ice candidate', e);
              }
          }

          // searching for callee candidate 

      });




      /////////////////////////////////////////////////////////////////////////////////////////

      socket.on("disconnection", senderName2 => {

      });

      const acceptButton = document.getElementsByClassName("Accept");
      document.addEventListener('click', function (e) {
          if (e.target && e.target.className == 'offerButton') {
              //Caller sending his offer to the callee 
              socket.emit("request", { type: "offer", name: e.target.id });
             // console.log(e.target.id);
          }
          if (e.target && e.target.className == 'acceptButton') {
             // console.log(e.target);
              let divModal = document.getElementById("offer").style.display = "none";
              //callee accepted the offer and sending back his answer to the caller 
              socket.emit("request", { type: "answer", name:changeUnderscoreIntoWhiteSpaces(e.target.id) });
             // console.log(changeUnderscoreIntoWhiteSpaces(e.target.id));
              caller = changeUnderscoreIntoWhiteSpaces(e.target.id);
          }

      });



   </script>

   
</head>

<body>

  <div class="container app">
    <div class="row app-one">
      <div class="modal" id="modal">
      </div>

      <div class="col-sm-4 side">
        <div class="side-one">
          <!-- Heading -->
          <div class="row heading">
            <div class="col-sm-3 col-xs-3 heading-avatar">
              <div class="heading-avatar-icon">
                <img src="img/man-2-512.png">
              </div>
            </div>
            <div class="col-sm-1 col-xs-1  heading-dot  pull-right">
              <i class="fa fa-ellipsis-v fa-2x  pull-right" aria-hidden="true"></i>
            </div>
          </div>

          <!-- Heading End -->

          <!-- SearchBox -->
          <div class="row searchBox">
            <div class="col-sm-12 searchBox-inner">
              <div class="form-group has-feedback">
                <input id="searchText" type="text" class="form-control" name="searchText"
                  placeholder="Recherchez un ami">
                <span class="glyphicon glyphicon-search form-control-feedback"></span>
              </div>
            </div>
          </div>

          <!-- Search Box End -->
          <!-- sideBar friend-->
          <div class="row sideBar" id="friends">

            <div class="row sideBar-body">
              <div class="col-sm-3 col-xs-3 sideBar-avatar">
                <div class="avatar-icon">
                  <img src="img/man-2-512.png"></img>
                </div>
              </div>
              <div class="col-sm-9 col-xs-9 sideBar-main">
                <div class="row">
                  <div class="col-sm-8 col-xs-8 sideBar-name">
                    <span class="name-meta">John Doe
                    </span>
                  </div>
                </div>
              </div>
            </div>

          </div>
          <!-- Sidebar End -->
        </div>
        <div class="side-two">

          <!-- Heading -->
          <div class="row newMessage-heading">
            <div class="row newMessage-main">
              <div class="col-sm-2 col-xs-2 newMessage-back">
                <i class="fa fa-arrow-left" aria-hidden="true"></i>
              </div>
              <div class="col-sm-10 col-xs-10 newMessage-title">
                New Chat
              </div>
            </div>
          </div>
          <!-- Heading End -->

          <!-- ComposeBox -->
          <div class="row composeBox">
            <div class="col-sm-12 composeBox-inner">
              <div class="form-group has-feedback">
                <input id="composeText" type="text" class="form-control" name="searchText" placeholder="Search People">
                <span class="glyphicon glyphicon-search form-control-feedback"></span>
              </div>
            </div>
          </div>
          <!-- ComposeBox End -->

          <!-- sideBar responsive -->
          <div class="row compose-sideBar">
            <div class="row sideBar-body">
              <div class="col-sm-3 col-xs-3 sideBar-avatar">
                <div class="avatar-icon">
                  <img src="img/man-2-512.png">
                </div>
              </div>
              <div class="col-sm-9 col-xs-9 sideBar-main">
                <div class="row">
                  <div class="col-sm-8 col-xs-8 sideBar-name">
                    <span class="name-meta">John Doe
                    </span>
                  </div>
                  <div class="col-sm-4 col-xs-4 pull-right sideBar-time">
                    <span class="time-meta pull-right">18:18
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>


        </div>
        <!-- Sidebar End -->
      </div>


      <!-- New Message Sidebar End -->

      <!-- Conversation Start -->
      <div class="col-sm-8 conversation">
        <!-- Heading right-->
        <div class="row heading">
          <div class="col-sm-2 col-md-1 col-xs-3 heading-avatar">
            <div class="heading-avatar-icon">
              <img src="img/man-2-512.png">
            </div>
          </div>
          <div class="col-sm-8 col-xs-7 heading-name">
            <a class="heading-name-meta">John Doe
            </a>
            <spa>Online</span>
          </div>
          <div class="col-sm-1 col-xs-1  heading-dot pull-right">
            <i class="fa fa-ellipsis-v fa-2x  pull-right" aria-hidden="true"></i>
          </div>
        </div>
        <!-- Heading End -->

        <!-- Message Box -->
        <div class="row message" id="conversation">

          <div class="row message-previous">
            <div class="col-sm-12 previous">
            </div>
          </div>

          <div class="row message-body">
            <!-- display logo when no friend selected -->
            <div class="Yolo_logo">
              <img src="img/LOGO_YOLO.png" alt="image" class="img-responsive center-block" />
            </div>
            <div class="description_logo">
              <h3 class="text-center">Click on a friend to start a conversation</h3>
            </div>
            <div id="modal"></div>

            <div class="col-sm-12 message-main-receiver">
              <div class="receiver">
                <!--
                <div class="message-text-">
                  Hey, Its Awesome..!
                </div>
              -->
              </div>

            </div>
          </div>

          <div class="row message-body">
            <div class="col-sm-12 message-main-sender">
              <div class="sender">
                <!--
                <div class="message-text">
                  Thanks n I know its awesome...!
                </div>
              -->
              </div>
            </div>
          </div>
        </div>
        <!-- Message Box End -->

        <!-- Reply Box -->
        <div class="row reply">
          <div class="col-sm-1 col-xs-1 reply-emojis">
            <i class="fa fa-smile-o fa-2x"></i>
          </div>
          <div class="col-sm-9 col-xs-9 reply-main">
            <textarea class="form-control" rows="1" id="messageInput"></textarea>
          </div>
          <div class="col-sm-1 col-xs-1 reply-recording">
            <i class="fa fa-microphone fa-2x" aria-hidden="true"></i>
          </div>
          <div class="col-sm-1 col-xs-1 reply-send">
            <i class="fa fa-send fa-2x" aria-hidden="true" id="button"></i>
          </div>
        </div>
        <!-- Reply Box End -->
      </div>
      <!-- Conversation End -->
    </div>
    <!-- App One End -->
  </div>

  <!-- App End -->
</body>
<!-- <script src="js/yolo_web_rtc.js">  -->

</script>
</html>